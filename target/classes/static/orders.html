<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orders · Neo</title>
  <script>(function(){try{if(!localStorage.getItem('token')) location.replace('/');}catch(e){}})();</script>
  <style>
    :root{--bg:#f6f7f9;--ink:#111827;--primary:#93c5fd;--primary-ink:#0f172a;--accent:#ffd803;--danger:#ff6b6b;--card:#fff;--shadow:6px 6px 0 #111827;--radius:10px;--border:3px solid #111827}
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:40px;color:var(--ink);background:var(--bg);background-image:linear-gradient(90deg,rgba(0,0,0,.04) 1px,transparent 1px),linear-gradient(0deg,rgba(0,0,0,.04) 1px,transparent 1px);background-size:24px 24px}
    .wrap{max-width:1200px;margin:0 auto}
    .title{display:inline-block;padding:10px 16px;background:var(--accent);border:var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin:0 0 20px 0}
    .panel{background:var(--card);border:var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input{padding:12px 14px;border:var(--border);border-radius:var(--radius);box-shadow:var(--shadow);outline:none;background:#fff;min-width:200px}
    button,.btn{padding:12px 16px;border:var(--border);border-radius:var(--radius);box-shadow:var(--shadow);cursor:pointer;background:var(--primary);color:var(--primary-ink);text-decoration:none;display:inline-block;margin:4px 6px 6px 0}
    .btn-accent{background:var(--accent);color:#111827}
    .btn-danger{background:var(--danger)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:#e5e7eb;text-align:left;padding:12px;border-top:var(--border);border-bottom:var(--border);border-left:var(--border)}
    thead th:last-child{border-right:var(--border)}
    tbody td{padding:12px;border-left:var(--border);border-bottom:var(--border);background:#fff}
    tbody tr td:last-child{border-right:var(--border)}
    .muted{color:#6b7280}
    button:active,.btn:active{transform:translate(3px,3px);box-shadow:3px 3px 0 #111827}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Orders</h1>
    <p class="muted">Lab 09–10 UI · <a class="btn" href="/home">Trang chủ</a> · <a class="btn" href="/products.html">Products</a> · <button class="btn btn-danger" onclick="logout()">Logout</button></p>
    <div class="panel">
      <div class="row">
        <button id="addRow" class="btn-accent">Thêm dòng</button>
        <button id="create" class="btn-accent">Tạo đơn</button>
        <button id="viewOrders" class="btn">Xem danh sách đơn</button>
      </div>
    </div>
    <div class="panel">
      <table>
        <thead>
          <tr><th>ProductId</th><th>Quantity</th><th>Unit Price</th><th>Hành động</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="panel"><b>Tổng tạm tính: </b><span id="sum">0</span></div>
    <div class="panel" id="ordersPanel" style="display:none;">
      <table>
        <thead>
          <tr><th>Order #</th><th>Total</th><th>Số items</th></tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API = '/api/orders';
    function authHeaders(){ const t=localStorage.getItem('token'); return t?{'Authorization':'Bearer '+t}:{ }; }
    async function fetchJSON(url, options){
      const res = await fetch(url, {headers:{'Content-Type':'application/json', ...authHeaders()}, ...options});
      if(!res.ok) throw new Error(await res.text());
      return res.status !== 204 ? res.json() : null;
    }
    function addRow(){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><input class="pid" placeholder="productId"/></td>
        <td><input class="qty" type="number" step="1" value="1"/></td>
        <td><input class="price" type="number" step="0.01" value="0"/></td>
        <td><button class="remove btn-danger">Xoá</button></td>`;
      document.getElementById('tbody').appendChild(tr);
      updateSum();
    }
    function updateSum(){
      let sum=0; document.querySelectorAll('#tbody tr').forEach(tr=>{
        const q=parseInt(tr.querySelector('.qty').value||'0',10);
        const p=parseFloat(tr.querySelector('.price').value||'0'); sum+=q*p;
      }); document.getElementById('sum').textContent=sum.toFixed(2);
    }
    async function createOrder(){
      const items=[]; document.querySelectorAll('#tbody tr').forEach(tr=>{
        const pid=tr.querySelector('.pid').value.trim();
        const qty=parseInt(tr.querySelector('.qty').value||'0',10);
        const price=parseFloat(tr.querySelector('.price').value||'0');
        if(pid && qty>0) items.push({productId:pid, quantity:qty, price});
      });
      if(items.length===0) return;
      await fetchJSON(API,{method:'POST', body: JSON.stringify({items})});
      document.getElementById('tbody').innerHTML=''; updateSum();
      alert('Đã tạo đơn');
    }
    async function loadOrders(){
      const list = await fetchJSON(API);
      const tb = document.getElementById('ordersBody'); tb.innerHTML='';
      list.forEach(o=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${o.orderNumber||o.id}</td><td>${(o.totalPrice||0).toFixed(2)}</td><td>${(o.items||[]).length}</td>`;
        tb.appendChild(tr);
      });
      document.getElementById('ordersPanel').style.display='block';
    }
    document.getElementById('addRow').addEventListener('click', addRow);
    document.getElementById('create').addEventListener('click', createOrder);
    document.getElementById('viewOrders').addEventListener('click', loadOrders);
    document.getElementById('tbody').addEventListener('input', updateSum);
    document.getElementById('tbody').addEventListener('click', (e)=>{
      if(e.target.classList.contains('remove')) e.target.closest('tr').remove(), updateSum();
    });
    function logout(){ localStorage.removeItem('token'); location.replace('/'); }
  </script>
</body>
</html>


